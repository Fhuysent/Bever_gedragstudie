---
title: "Locatiegegevens van gekende burchten en holen langs de Durme (segment N70 - Daknambrug)"
author: "Frank Huysentruyt"
date: "17-5-2022"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(leaflet)
library(suncalc)
library(geosphere)
library(sp)
```

```{r data inlezen MyMaps, echo = FALSE, warning = FALSE}
BeverIDs <- read.csv("../Input/Bevers_Lokeren.csv")

fileNames <- Sys.glob("../Input/MyMaps/*.csv")

for (i in fileNames) {
  assign(
    unlist(regmatches(i, gregexpr("(?<=MyMaps/).*?(?=\\.csv)", i, perl=T))),
    read.csv(i, header=TRUE, sep=,) %>% 
      mutate(WKT = regmatches(WKT, gregexpr("(?<=\\().*?(?=\\))", WKT, perl=T))) %>% 
      separate(WKT, c('x','y'), sep=" ") %>% 
      mutate(x = as.numeric(x), y = as.numeric(y))
  )
  }
remove(i, fileNames)

#Opkuisen

#Van Google time (PST sinds 1/1/1970 * 1000000) naar onze tijd
Googletime <- function(x) {
  as.POSIXct((as.numeric(x)/1000000)-32400, origin = "1970-01-01")
}

Bevers <- Bevers %>%
  mutate(Tijdstip = Googletime(Tijdstip))
  
Cameras <- Cameras %>%
  mutate(Opzet = Googletime(Opzet),
         Afbraak = Googletime(Afbraak)) %>% 
  rename(Camera = Nummer)
    
Kooien <- Kooien %>%
  mutate(Opzet = Googletime(Opzet),
         Afbraak = Googletime(Afbraak))

Sporen <- Sporen %>%
  filter(!is.na(x)) %>% 
  select(-description) %>% 
  mutate(Datum = Googletime(Datum)) %>% 
  mutate(Type = str_remove_all(Type, fixed("Â"))) %>% 
  mutate(Status = str_remove_all(Status, fixed("Â")))

``` 

# Aanleiding

Dit document kadert binnen het project "Onderzoek naar de invloed van beheeringrepen op gedrag van bevers" ([INBOPR-17926](https://www.vlaanderen.be/inbo/projecten/onderzoek-naar-de-invloed-van-beheeringrepen-op-gedrag-van-bevers)). Binnen dit project onderzoekt het Instituut voor Natuur- en Bosonderzoek ([INBO](https://www.vlaanderen.be/inbo/)) in opdracht van De Vlaamse Waterweg ([DVW](https://www.vlaamsewaterweg.be/)) en ter voorbereiding van werken aan de dijk langs de Durme in Lokeren, op die locatie het habitatgebruik van de aanwezige bevers. Het onderzoek gebeurt zowel voorafgaand als volgend op de uit te voeren werken.

Op 4 mei 2022 ontving INBO via e-mail de vraag om een kaart aan te leveren van de locaties van territoria, holen en burchten, zoals op dat moment gekend. Deze info zal de aannemer toelaten rekening te houden met de aanwezigheid van bevers bij de indiening van offertes, rekening houdend met de elementen die hierover in de verscherpte natuurtoets voor dit project, opgemaakt door het studiebureau Sweco in opdracht van DVW, staan. 

# Aanpak

De resultaten die hier worden gerapporteerd maken deel uit van de eerste fase van dit onderzoek, die is gestart op `r format(min(Kooien$Opzet), "%d %b %Y")` en loopt tot op vandaag `r format(Sys.Date(), "%d %b %Y")`. Deze fase bestond uit drie grote onderdelen:
  
  - inventariseren van sporen
  - monitoren met wildcamera's
  - vangen en opvolgen van individuele bevers
  
In een latere, gedetailleerde rapportage zullen deze methoden in detail worden toegelicht. In het kader van deze datavraag verwijzen we naar de methodiek beschreven in [Huysentruyt _et al._ (2020)](https://purews.inbo.be/ws/portalfiles/portal/18065303/Huysentruyt_etal_2020_OnderzoekNaarHetHabitatgebruikVanBeverInRelatieTotSchadebeheer.pdf), dat ook [online beschikbaar](https://inbo.github.io/fis-reports/Reports/Beaver%20telemetry/2-materiaal-en-methoden.htm) is.

Hieronder bespreken we per deelvraag welke gegevens werden gebruikt voor het beantwoorden ervan.

# Resultaten

## Ligging holen en burchten

Voor het bepalen van de ligging van de holen en burchten gebruiken we eerst de resultaten van de sporeninventarisaties. Er werden in totaal `r nrow(Sporen %>% filter(Type != "Waarneming" & Type != " bever niet zichtbaar"))` sporen van bevers gevonden, waarvan `r nrow(Sporen %>% filter(Type != "Waarneming" & Type != " bever niet zichtbaar") %>% filter(y < 51.13 & y > 51.11))` binnen het beoogde segment zelf. `r nrow(Sporen %>% filter(Type == "Burcht") %>% filter(y < 51.13 & y > 51.11))` daarvan waren burchtlocaties.

```{r burchtenkaart, fig.cap = "Kaart met visueel zichtbare burchtlocaties", echo = FALSE, warning = FALSE}
# selectie van visueel herkende burchten binnen het gebied
Burchtenmap <- Sporen %>% 
  filter(Status != 'Mortality') %>% 
  filter(Status == 'Actief') %>% 
  filter(Type == 'Burcht') %>% 
  filter(y < 51.13 & y > 51.11)

leaflet(data=Burchtenmap) %>% 
  addTiles() %>% 
  addCircleMarkers(~x,~y, color = 'darkgreen' , stroke = F, radius = 7, fillOpacity = 0.8) %>% 
  addLegend("bottomright", colors = 'darkgreen', labels = 'burchten', 
            title = "Zichtbare sporen",
            opacity = 0.8)
```

Figuur \@ref(fig:burchtenkaart) toont... 


## Ligging territoria

Alle waarnemingen individuele dieren samen

```{r telemetrie, echo = FALSE, warning = FALSE}
Telemetrie <- read.csv("../Input/Telemetrie/Telemetrie.csv") %>% 
  filter(ID != "") %>% 
  separate(LatLong , c('y','x'), sep = ",") %>% 
  mutate(across(c(x,y), as.numeric)) %>% 
  mutate(Datum = as.POSIXct(strptime(Datetime_local, "%d-%m-%Y %H:%M:%S"))) %>% 
  mutate(Bever_ID = as.integer(Bever_ID)) %>% 
  select(-c(Datetime_UTC, Datetime_local)) %>% 
  left_join(BeverIDs[,c("bever", "VHF.kort")], by = c("Bever_ID" = "VHF.kort")) %>% 
  mutate(getSunlightTimes(date=as.Date(Datum), lat=as.numeric(mean(y)),
                                    lon=as.numeric(mean(x)),tz="CET")[6:7]) %>% 
  mutate(across(c(Datum,sunrise,sunset)), Tijdstip = ifelse(Datum>sunrise+5200 & Datum<sunset-5200, "Dag", "Nacht"))
  
```

```{r kaartjes Telemetrie, echo = FALSE, warning = FALSE}
TelemetrieMap <- Telemetrie %>% 
  filter(y<51.13 & y>51.11) %>% 
  filter(Tijdstip=="Dag")

#punten binnen de 10m van elkaar clusteren
allepunten <- SpatialPoints(data.frame("x" = TelemetrieMap[,4],
                                       "y" = TelemetrieMap[,3]),
                            proj4string = CRS("+init=epsg:4326"))

hc <- hclust(as.dist(distm(allepunten)), method="complete")
TelemetrieMap$clust <- factor(cutree(hc, h=10))

TMBurchten <- TelemetrieMap[,c(3:4,11)] %>% 
  group_by(clust) %>% 
  summarise(x = mean(x), y = mean(y))
  
pal <- colorFactor(
  palette = c('blue','green','red','orange'),
  domain = TelemetrieMap$bever
)

leaflet(data=TelemetrieMap) %>% 
  addTiles() %>% 
  addCircleMarkers(~x,~y, color=~pal(bever),stroke = F, radius=5, fillOpacity = 0.8) %>% 
  addLegend("bottomright", pal = pal, values = ~bever,
    title = "Bever",
    opacity = 1)
```


```{r geïntegreerde kaart, echo = FALSE, warning = FALSE}
leaflet(data = TMBurchten) %>% 
  addTiles() %>% 
  addCircleMarkers(~x,~y, color = 'blue', stroke = F, radius=5, fillOpacity = 0.8) %>% 
  addCircleMarkers(data = Burchtenmap, ~x,~y, color = 'red', stroke = F, radius=5, fillOpacity = 0.8) %>% 
  addLegend("bottomright", colors = c('blue','red'), labels = c('dagrustplaatsen','zichtbare burchten'), 
            title = "Potentiële burchten/holen",
            opacity = 1)
```
```