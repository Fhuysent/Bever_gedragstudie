---
title: "Data"
author: "Frank Huysentruyt"
date: "21-4-2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(leaflet)
library(lubridate)
library(inborutils)
```

## Inlezen Gegevens

In het project werden een aantal bevers gezenderd en via telemetrie opgevolgd. Elk van deze bevers kreeg daarbij zowel een VHF als Akoestische zender. De VHF zenders leveren manuele locatiebepalingen met behulp van antennes op, akoestische zenders leveren automatische locaties op ter hoogte van vaste receivers.

De gegevens van de verschillende databronnen worden als volgt gecompileerd:
  - *AKOdata*: gegevens akoestische receivers uit csv-bestanden met deployments en met detecties
  - *VHFdata*

```{r data inlezen Akoestiek, include=FALSE}
#deployments inlezen
AKOdep <- read.csv("../Input/Akoestiek/Deployments/ETN-deployments.csv", header=TRUE, sep=,)
#alle deployments en recoveries op de middag zetten (misschien nog vervangen door exacte uur)
AKOdep$deployDateTime <- as.POSIXlt(as.Date(AKOdep$deployDateTime))+43200
AKOdep$recoverDateTime[AKOdep$recoverDateTime==""] <- as.character(Sys.time())
AKOdep$recoverDateTime <- as.POSIXlt(as.Date(AKOdep$recoverDateTime))+43200

#detecties inlezen
fileNames <- Sys.glob("../Input/Akoestiek/*.csv")
AKOdet <- NULL
##samenvoegen gegevens met verwijderen van eventuele dubbels ontstaan door niet wissen tussen uitlezen
for (fileName in fileNames) {
  AKOdet <- unique(rbind(AKOdet, read.csv(fileName, header=TRUE, sep=,)))
}
remove(fileName, fileNames)

colnames(AKOdet)[1] <- "Date"
AKOdet$Date <- as.POSIXlt(AKOdet$Date)

#merge alle niet volledig NA kolommen
not_all_na <- function(x) any(!is.na(x))
AKOdata <- AKOdet %>% 
  inner_join(AKOdep, by = c("Receiver"="receiver")) %>% 
  select(where(not_all_na)) %>% 
  filter(Date>deployDateTime & Date<recoverDateTime)
remove(not_all_na)

AKOdep_all <- NULL
for (Station in AKOdep$stationName) {
  
  tmp <- filter(AKOdep, stationName == Station)
  
  for (Start in tmp$deployDateTime) {
    
    tmp2 <- filter(tmp, deployDateTime == Start) %>% 
    mutate(start = as.Date(deployDateTime),
           stop = as.Date(recoverDateTime)) %>% 
    select(receiver, start, stop, deployLat, deployLong)
    
    tmp2 <- expand.grid(receiver = tmp2$receiver,
                        station = Station,
                        x = tmp2$deployLong,
                        y = tmp2$deployLat,
                        dates=seq(tmp2$start,tmp2$stop,by="day"))
    
    AKOdep_all <- unique(rbind(AKOdep_all,tmp2))
  }
  }
remove(Station, Start, tmp, tmp2)
  
```

## Akoestische data
Plotjes om data te controleren.

```{r akoestiek, echo=FALSE}
AKOdata$Dateshort <- as.Date(AKOdata$Date)

AKOdata %>% group_by(Dateshort,Transmitter,Receiver,Station.Name) %>% 
  summarize(observations=length(Transmitter)) %>% 
  ggplot(aes(x=Dateshort,y=observations)) + geom_point() + facet_grid(~Station.Name)

AKOdatamap <- AKOdata %>% 
  group_by(Dateshort,Receiver,Transmitter) %>% 
  summarize(x=first(deployLong),y=first(deployLat))

leaflet(data=AKOdep_all) %>% 
  addTiles() %>% 
  addCircleMarkers(~x,~y)
```
```{r data inlezen Akoestiek, include=FALSE}
setwd("../Input/kml")
fileNames <- Sys.glob("../Input/MyMaps/*.kml")

read_kml_file <- function(filename) {
    kml_text <- readLines(filename)
    coords <- grep("<coordinates>", kml_text)
    coord <- as.data.frame(kml_text[coords + 1])
    colnames(coord) <- c("ruw")
    coords <- coord %>%
        separate(.data$ruw, c("x", "y", "z"), ",")

    data_ids <- grep("<Data name", kml_text)
    data_names <- regmatches(kml_text[data_ids], gregexpr("\\<.*?\\>", kml.text[data_ids]))
    data_names <- unique(unlist(data_names))[-(1:3)]
    data_ids2 <- grep(data_names[[1]], kml_text)
    data_ids2 <- data_ids2[data_ids2 %in% data_ids]
    tmp <- kml_text[data_ids2 + 1]
    data_values <- regmatches(tmp, gregexpr("(?<=\\>).*?(?=\\<)", tmp, perl=T))
  
    dates_raw <- kml_text[dates+1]
    dates_matched <- regmatches(dates_raw,
                        regexpr("[0-9]{2}-.*-[0-9]{4}.*[0-9]{2}:[0-9]{2}",
                                dates_raw))
    dates <-  as.POSIXct(strptime(dates_matched, format = "%d-%b-%Y %H:%M:%S"))
    datetime <- as.data.frame(dates)
    colnames(datetime) <- c("datetime")

    data <- cbind(datetime, coords[,1:2])
    data$x <- as.numeric(data$x)
    data$y <- as.numeric(data$y)
    return(data)
}

fileNames <- Sys.glob("../Input/MyMaps/*.csv")
data <- read.csv(fileNames)
data$Tijdstip <- as_datetime(data$Tijdstip)
``` 
